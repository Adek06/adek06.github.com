<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>虛擬內存 | Gamer——游先生的个人网站</title>
<meta name="description" content="跟游戏有什么关系">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://adek06.github.io//favicon.ico?v=1570974778878">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://adek06.github.io//styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://adek06.github.io/">
        <img src="https://adek06.github.io//images/avatar.png?v=1570974778878" class="site-logo">
        <h1 class="site-title">Gamer——游先生的个人网站</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      跟游戏有什么关系
    </div>
    <div class="site-footer">
      我是游先生 | <a class="rss" href="https://adek06.github.io//atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">虛擬內存</h2>
            <div class="post-date">2019-08-17</div>
            
            <div class="post-content">
              <h2 id="没有虚拟内存带来的问题">没有虚拟内存带来的问题</h2>
<p>我们在运行程序时，总希望内存越大越好，这样可以运行的程序也可以越来越多，越来越大。但现实是，这样做是有很多成本的。最简单的成本就是钱。过去，爲了解决这个问题，人们写程序时，会考虑到内存大小，如果自己写的程序大过内存，那麽还要做一些工作，比如：想办法，只加载一部分代码，当有更多的需要时，再加载更多。</p>
<p>这是一个相当有开创性的想法。这一想法在后来诞生了虚拟内存的伟大概念。（我瞎掰的）</p>
<h2 id="虚拟内存的基本原理">虚拟内存的基本原理</h2>
<p><img src="https://adek06.github.io//post-images/1566035265964.png" alt=""></p>
<p>简单来说，当我们运行一个进程时，计算机并不会把整个程序都加载进内存里，而是放在硬盘上，当有需要时，再将加载需要的那一部分。</p>
<p>那我们怎麽知道要加载哪一部分？比如说，我的下一条指令是到要变量 B，可是变量 B 没加载进内存，我也不知道它在哪，要怎麽去硬盘里找？</p>
<p>那好吧，爲了做好映射关係，我们还要在进程运行时，给进程一张表，它负责进行内存和硬盘之间的关係。比如说，变量 B 的内存是 Ox11011，发现这在内存里不存在，那麽我们就去表上找，发现它在对应着内存里的 Ox00100，那麽我们就把内存里的那个 B 给它。</p>
<p>但如果每一个变量，每个字都做映射，都要到硬盘里找，这实在是太麻类了。更重要的是，对硬盘做一次查询，所消耗的时间太长了，在 CPU 看来，每进行一次，都要花费 10 个月的时间。爲了省时省力，我们把程序分成多个部分，每一部分叫做一个虚拟页。同时，内存里也分成多个页，叫物理页。每一个物理页都可以容纳一个虚拟页。而映射它们的那张表，叫页表。</p>
<p>现在我们来看看一个实例，虚拟地址是如何转换成物理地址的。</p>
<p>一般而言，计算机是通过多级页表进行转换的，但爲了简单，这里就讨论只有一张页表的情况。</p>
<p>现在设有 14 位的虚拟地址，要转换成 12 位的真实地址。其中，页表大小爲 64(2的6次方) B。</p>
<ol>
<li>
<p>通过虚拟地址位数和页大小，我们可以换算得到，共有 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><msup><mn>2</mn><mn>14</mn></msup><msup><mn>2</mn><mn>6</mn></msup></mfrac><mo>=</mo><mn>256</mn></mrow><annotation encoding="application/x-tex">\cfrac{2^{14}}{2^6}=256</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.276em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5899999999999999em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.74em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span></span></span></span> 项。也就是说，要 8 位数才能表示完所有页(VPN)。那麽 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>14</mn><mo>−</mo><mn>8</mn><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">14-8=6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span></span></span></span> 来表示偏移量(VPO)。</p>
</li>
<li>
<p>由虚拟地址的偏移量，我们可以知道真实地址的偏移量。（两者相等）</p>
</li>
</ol>
<p>比如下面，我们已知虚拟地址爲 00101100100010 （VPN(8) VPO(6)）</p>
<p>那麽 00101100 爲虚拟页的首地址（页码）。100010 爲虚拟地址的偏移量。</p>
<p>通过查页表，将 00101100 映射爲真实地址，假设爲 11010011，再加上偏移量 100010 得到真实地址 11010011100010.</p>
<blockquote>
<p>00101100100010 =&gt; 11010011100010</p>
</blockquote>
<p>到这里，地址转换就完成了！</p>
<p>如果是多级页表，也只是通过多个 虚拟首地址（页码） 的转换而已。变成 VPN VPN VPN VPN ... VPO。</p>
<h2 id="它带来的好处">它带来的好处</h2>
<p>简化链接、简化内存分配（不连续）、进程上的安全（不会干扰到其它进程）</p>
<p>虚拟内存的出现，给我们带来了意想不到的好处。</p>
<p>首先，它简化了链接过程。当程序编译完成时，程序里的每一个变量，每一个函数，还只是对应一个相对的地址，想要执行，还得有一个动态链接过程。由于虚拟页的存在，生成的可执行文件的地址可以独立于物理内存，这样设计链接器时，就简单得多。</p>
<p>另外，因爲虚拟页与物理页之间是靠页表进行映射的，因此，一个进程的不周数据在物理内存里，可以不连续。毕竟查表就能知道它们的位置了，连不连续已经不重要了。于是，这样内存可以更动态，更轻鬆的进行分配。</p>
<p>最后，可以虚拟化进程了。进程因爲页表的存在，不会存在相互干扰了。两个进程因爲页表与页表之间不同，映射到的地方不同，那怕虚拟地址相同，物理内存上也不会相同，它们之间彷彿有一道牆，阻止它们相互侵犯。</p>
<h2 id="虚拟化">虚拟化</h2>
<p>没错，地址也可以虚拟化。还有多少东西可以虚拟化呢？真的好期待啊。</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://adek06.github.io//tag/bSI1dx03W" class="tag">
                    计算机系统
                  </a>
                
                  <a href="https://adek06.github.io//tag/B160eImvr" class="tag">
                    虚拟化
                  </a>
                
                  <a href="https://adek06.github.io//tag/8XounFizo" class="tag">
                    学习
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://adek06.github.io//post/dui-yu-xu-ni-hua-de-zhi-zhao">
                  <h3 class="post-title">
                    对于虚拟化的执着
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
